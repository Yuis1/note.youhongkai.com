---
{"dg-publish":true,"permalink":"/CS计算机科学/Drupal/Drupal安全/Drupal 加密解密/","noteIcon":"","created":"2024-06-22T22:30:28.396+08:00","updated":"2024-04-23T23:01:10.000+08:00"}
---


作者: 游鱼思

---

在Drupal中安全存储用户提供的交易密钥，特别是在服务器可能被入侵的情况下保护密钥不被以明文形式泄露，需要采取加密存储的方式。Drupal社区提供了一些模块来帮助你实现这一目标。以下是一些能够帮助你安全存储敏感信息，如交易密钥的Drupal模块：

1. **Key**模块：这个模块提供了一个统一的方式来管理网站上的密钥，包括API密钥和加密密钥。它可以与其他需要存储密钥的模块集成，提供了密钥的基本存储和管理功能。Key模块本身不进行加密，但可以与加密模块一起使用，以确保密钥安全地存储在服务器上。
2. **Encrypt**模块：这个模块为Drupal提供了加密服务。它允许你加密存储在数据库中的数据，包括用户提供的交易密钥。Encrypt模块依赖于强大的加密库（如OpenSSL），可以配置不同的加密方法和密钥管理策略。结合Key模块，Encrypt模块可以实现高度安全的密钥存储解决方案。
3. **Real AES**模块：这个模块扩展了Encrypt模块，提供了基于AES（高级加密标准）的真实加密实现。AES是一种广泛使用的加密标准，可以提供强大的数据保护。使用Real AES模块可以确保你的加密密钥以非常安全的方式存储，即使服务器被入侵，黑客也无法轻易解密出明文。
4. **Field Encryption**模块：如果你需要加密数据库中特定字段的数据，Field Encryption模块可以满足你的需求。它可以用来加密存储在字段中的任何数据，包括用户提供的交易密钥。这个模块可以与Encrypt模块一起使用，为Drupal站点上的敏感数据提供字段级别的加密。

## Encrypt 模块

Encrypt模块在Drupal中提供了一个强大的框架来加密和解密存储在网站上的数据，包括但不限于用户提供的交易密钥。它通过结合密钥管理（如使用Key模块管理密钥）和加密服务，使得数据可以安全地存储在服务器上，同时在需要的时候可以安全地解密。以下是Encrypt模块工作机制的详细说明：

### 加密过程

1. **密钥管理**：首先，需要一个安全的方式来存储用于加密和解密的密钥。这通常通过使用Key模块实现，该模块允许你在不同的存储后端（如文件系统、数据库或第三方密钥管理服务）中安全地管理密钥。
2. **配置加密方法**：在Encrypt模块中，你可以选择不同的加密方法（如AES），这些方法由安装在服务器上的加密库（如OpenSSL）提供。选择合适的加密算法是确保数据安全的关键。
3. **加密数据**：当需要存储敏感信息（如交易密钥）时，Encrypt模块会使用配置好的加密方法和密钥来加密这些数据。然后，加密后的数据可以安全地存储在数据库或文件系统中，即使在数据泄露的情况下，没有相应的密钥和解密算法，这些数据也无法被恶意用户解读。

### 解密过程

当需要访问原始数据（如交易密钥明文）时，Encrypt模块会执行以下步骤来安全地解密数据：

1. **检索加密数据**：首先，系统会从存储位置检索加密后的数据。
2. **获取密钥**：然后，系统会从Key模块指定的安全存储后端获取用于加密该数据的密钥。
3. **解密数据**：有了加密数据和相应的密钥，Encrypt模块使用相同的加密算法以相反的过程解密数据，还原出原始数据（明文）。

### 安全性和灵活性

Encrypt模块通过分离密钥管理和加密逻辑，提供了高度的安全性和灵活性。这种分离确保了即使攻击者能够访问加密后的数据，没有密钥他们也无法解密这些数据。同时，只有授权的用户或系统才能访问用于解密的密钥，这进一步提高了安全性。

此外，通过支持多种加密方法和密钥存储选项，Encrypt模块能够适应不同的安全需求和合规要求。例如，对于需要高度安全性的场景，可以选择更强的加密算法和更安全的密钥存储解决方案。

## Real AES模块

Real AES（Advanced Encryption Standard）模块是Drupal的一个扩展模块，它提供了基于AES算法的加密功能，增强了Drupal网站的数据安全性。AES是一种广泛使用的加密标准，被认为是目前最安全的加密算法之一，广泛应用于政府、金融和私人领域以保护敏感信息。Real AES模块通过提供对这种高级加密标准的支持，使Drupal网站能够更安全地处理和存储敏感数据。以下是Real AES模块工作机制的详细说明：

### 密钥生成和管理

- **密钥长度**：Real AES模块支持多种密钥长度，包括128位、192位和256位。密钥的长度直接影响加密的强度，密钥越长，加密就越安全。
- **密钥存储**：密钥通常通过Key模块安全地存储和管理。Key模块允许将密钥存储在服务器的不同位置，包括配置文件、数据库或使用外部密钥管理服务。

### 加密和解密过程

- **加密**：当需要加密数据时，Real AES模块会使用预先配置的密钥和AES加密算法对数据进行加密。加密过程中，它会将明文数据转换为无法直接读取的密文，确保即使数据被未授权访问，也无法理解其内容。
- **解密**：当需要访问原始明文数据时，Real AES模块使用相同的密钥和AES算法对密文进行解密，恢复出原始的明文数据。只有拥有正确密钥的用户或系统才能解密数据，保证了数据的机密性和安全性。

### 安全特性

- **块加密**：AES是一种块加密标准，意味着它会将数据分成固定大小的块进行加密。如果数据块不足算法要求的长度，会使用特定的填充技术来补足。
- **加密模式**：Real AES模块支持多种AES加密模式，如CBC（Cipher Block Chaining）和GCM（Galois/Counter Mode）。不同的加密模式影响加密过程的安全性和效率，其中GCM模式还提供了数据的完整性验证。

### 总结

Real AES模块为Drupal网站提供了一种高级的数据加密手段，通过使用行业标准的AES算法保护敏感信息。结合安全的密钥管理和灵活的加密配置，Real AES模块可以显著提高Drupal网站处理敏感数据的安全性。它适合需要高度数据保护的网站，如电子商务平台、金融服务网站和任何处理个人识别信息的网站。通过实现Real AES加密，Drupal网站管理员可以确保他们的网站在存储和传输数据时符合最高的安全标准。

## 问题排查

开启 real_aes、field_encrypt 等模块后，进到字段编辑页面，没发现加密选项。

在Encryption profiles配置中，点 操作 - 测试，报错。

原来是 key 选的不对，应该创建 Encryption 类型的 key。

再次测试，成功加密、解密了。

但是字段中还是没有加密选项。

查issue，发现是和10.2不兼容：[Compatibility with Drupal 10.2: Encrypting fields not possible [#3421958] | Drupal.org](https://www.drupal.org/project/field_encrypt/issues/3421958)

解决办法：下载这个Patch   https://git.drupalcode.org/project/field_encrypt/-/merge_requests/41.patch 到模块目录，"git apply 41.patch"